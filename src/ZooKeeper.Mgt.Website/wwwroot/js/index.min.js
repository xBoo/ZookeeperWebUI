function OnClick(n,t,i){var r=i.bakValue,u=r.split("/"),f;u.length!==0&&u.pop().indexOf("$$")===0&&($("#config-address").html(r),i.open===!1?expandNode(i):(f=$.fn.zTree.getZTreeObj("zktree"),f.expandNode(i,!1,!0,!0)),getzknodes(r))}function getzknodes(n){var t="/Config/GetChildNodes?path="+n;$.ajax({url:t,type:"Get",datatype:"Json",success:function(n){$("#node-content").html("");n.businessCode!==-1?showTables(n.returnObj):alert(n.businessMessage)},error:function(){alert("服务器访问错误")}})}function showTables(n){if(n.length>0)for(var t=0;t<n.length;t++)randerTable(n[t])}function randerTable(n){for(var r="",i=0;i<n.nodes.length;i++){var t=n.nodes[i],u=n.path+"/"+t.key,e="checked="+t.isEncryptDisplay==!0?"checked":"",f=t.isEncryptDisplay===!0?'checked="checked" disabled="disabled"':"";r+=" <tr><td>"+t.key+"<\/td><td>"+t.value+"<\/td><td>"+t.description+'<\/td><td><input type="checkbox" disabled="disabled" '+f+' /><\/td><td><span name="edit" data-path="'+u+'" class="label label-success option-hover">edit<\/span>&nbsp;<span name= "delete" data-path="'+u+'" class="label label-danger option-hover" >del<\/span>&nbsp;<\/td><\/tr>'}$("#node-content").append('<div class="box"><div class="box-header"><h3 class="box-title">'+n.viewPath+'<\/h3><span name="delete-all" data-path="'+n.path+'" class="label label-warning option-hover">delete all<\/span><\/div><div class="box-body table-responsive no-padding"><table class="table table-hover table-width"><tbody><tr><th>Key<\/th><th>Value<\/th><th>Description<\/th><th>IsEncrypted<\/th><th>Option<\/th><\/tr>'+r+"<\/tbody><\/table><\/div><\/div>")}function add(n,t){var i=$.fn.zTree.getZTreeObj("zktree");n&&(i.removeChildNodes(n),i.addNodes(n,t))}function addnode(){var i=$.trim($("#add_key").val()),o=$.trim($("#add_Value").val()),s=$.trim($("#add_Decription").val()),h=$("#add-isparent").prop("checked"),c=$("#add-encrypted").prop("checked"),r,n,t,u,f,e;if(i===""){alert("Key 不能为空");return}if(i.indexOf("$$")===0){alert("系统规定，Key 不能以'$$'打头");return}if(r=$.fn.zTree.getZTreeObj("zktree"),n=r.getSelectedNodes(),n.length===0){if(u=confirm("警告: 没有选择父节点，将默认添加到根节点，是否继续？"),u===!1)return;t="/"}else if(t=n[0].bakValue,f=t.split("/"),f.pop().indexOf("$$")!==0){alert("请先选定父节点，再进行节点的添加操作！");return}e="/Config/CreateZNode?path="+t+"&isParent="+h;$.ajax({url:e,type:"Post",datatype:"Json",data:{key:i,value:o,description:s,isencryptdisplay:c},success:function(t){if(t.returnObj===!1){alert(t.businessMessage);return}$("#add_key").val("");$("#add_Value").val("");$("#add_Decription").val("");$("#add-isparent").prop("checked",!1);$("#add-encrypted").prop("checked",!1);n.length>0?(expandNode(n[0]),getzknodes(n[0].bakValue)):expandNode(null)},error:function(){alert("服务器访问错误")}})}function exportnodes(){var n=$.fn.zTree.getZTreeObj("zktree"),t=n.getSelectedNodes(),i=t[0].bakValue,r="/Config/Export?path="+i;window.location=r}function clearChildren(){var t=$.fn.zTree.getZTreeObj("zktree"),n=t.getSelectedNodes(),i=n[0];if(n.length==0||!n[0].isParent){alert("请先选择一个父节点");return}t.removeChildNodes(i)}function init(){$.ajax({url:"/Config/GetTreeNodes?path=/",type:"GET",datatype:"Json",success:function(n){n.businessCode!==-1?$.fn.zTree.init($("#zktree"),setting,n.returnObj):alert(n.businessMessage)},error:function(){alert("服务器访问错误")}})}function beforeExpand(n,t){return expandNode(t),t.expand!==!1}function expandNode(n){var t,i,r;n==null&&(t=$.fn.zTree.getZTreeObj("zktree"),n=t.getNodes()[0]);i=n.bakValue;r="/Config/GetTreeNodes?path="+i+"&parentId="+n.id;$.ajax({url:r,type:"GET",datatype:"Json",success:function(t){t.businessCode!==-1?add(n,t.returnObj):alert(t.Message)},error:function(){alert("服务器访问错误")}})}function option(){var n=$(this).attr("name"),t=$(this).data("path");n==="delete"?deleteopt(t):n==="delete-all"?deleteallopt(t):n==="edit"&&editoption($(this),t)}function deleteopt(n){var i=confirm("确认删除？"),t;i!==!1&&(t="/Config/DeleteZNode?path="+n,$.ajax({url:t,type:"Get",success:function(n){if(n.returnObj===!1)alert(n.businessMessage);else{var i=$.fn.zTree.getZTreeObj("zktree"),t=i.getSelectedNodes();t.length>0&&(expandNode(t[0]),getzknodes(t[0].bakValue))}},error:function(){alert("服务器访问错误")}}))}function deleteallopt(n){var i=confirm("此操作会删除该节点以及所有的子节点,确认删除？"),t;i!==!1&&(t="/Config/DeleteRecursiveZNode?path="+n,$.ajax({url:t,type:"Get",success:function(n){var i,r,t;n.returnObj===!1?alert(n.businessMessage):(i=$.fn.zTree.getZTreeObj("zktree"),r=i.getSelectedNodes(),r.length>0&&(t=r[0].getParentNode(),$("#config-address").html("节点配置地址："+t.bakValue),i.selectNode(t),expandNode(t),getzknodes(t.bakValue)))},error:function(){alert("服务器访问错误")}}))}function saveopt(){var n=$("#edit-path").val(),t=$("#edit-key").html(),i=$.trim($("#edit-value").val()),r=$.trim($("#edit-desc").val()),u=$("#edit-encrypt").prop("checked");$.ajax({url:"/Config/UpdateZNode?path="+n,type:"Post",datatype:"Json",data:{key:t,value:i,description:r,isencryptdisplay:u},success:function(n){if(n.returnObj===!0){$("#edit-value").val("");$("#edit-desc").val("");$("#edit-encrypt").prop("checked",!1);$("#edit-path").val("");$("#editModel").modal("hide");$("#btnEditModel").button("reset");var i=$.fn.zTree.getZTreeObj("zktree"),t=i.getSelectedNodes();t.length>0&&(expandNode(t[0]),getzknodes(t[0].bakValue))}else alert(n.businessMessage)},error:function(){alert("服务器访问错误")}})}function editoption(n,t){$.ajax({url:"/Config/GetNode?path="+t,type:"Get",success:function(n){var i,r,u;if(n.businessCode!==-1){if(i=n.returnObj,$("#edit-key").html(i.key),r=i.isEncryptDisplay?"":i.value,r!=null)try{u=JSON.stringify($.parseJSON(r),null,4)}catch(f){u=r}$("#edit-value").val(u);$("#edit-desc").val(i.description);$("#edit-encrypt").prop("checked",i.isEncryptDisplay);i.isEncryptDisplay?$("#edit-encrypt").prop("disabled","disabled"):$("#edit-encrypt").prop("disabled","");$("#edit-path").val(t);$("#btnEditModel").button("reset");$("#editModel").modal()}else alert(n.businessMessage)},error:function(){alert("服务器访问错误")}})}function isJsonFormat(n){try{$.parseJSON(n)}catch(t){return!1}return!0}var setting={view:{selectedMulti:!1},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1},data:{keep:{parent:!0,leaf:!0},simpleData:{enable:!0}},callback:{beforeExpand:beforeExpand,onClick:OnClick}};$(document).ready(function(){init();$("#submit_add").bind("click",addnode);$("#submit_export").bind("click",exportnodes);$("#btnEditModel").bind("click",saveopt);$("#submit_import").fileupload({url:"/Config/Import",dataType:"json",add:function(n,t){var i=$.fn.zTree.getZTreeObj("zktree").getSelectedNodes(),r;if(i.length===0){alert("请先选定上传对应的父节点！");return}if(r=i[0].bakValue,t.formData={path:r},t.files.length!==1){alert("一次只能上传一个文件");return}if(confirm("为了防止上传误操作，当前限制只能针对某一个父节点进行操作，并且上传文件会覆盖原有所有节点配置,您确认上传吗？"))t.submit();else return},done:function(n,t){if(t.result.returnObj==!0){alert("导入成功");var i=$.fn.zTree.getZTreeObj("zktree").getSelectedNodes();expandNode(i[0]);getzknodes(i[0].bakValue)}else alert("导入失败："+t.result.businessMessage)},fail:function(){alert("上传文件错误！")}});$("#node-content").delegate("div span","click",option);$("#add-encrypted").bind("click",function(n){n.currentTarget.checked?$("#add-isparent").prop("disabled","disabled"):$("#add-isparent").prop("disabled","")});$("#add-isparent").bind("click",function(n){n.currentTarget.checked?($("#add-encrypted").prop("checked",!1),$("#add-encrypted").prop("disabled","disabled")):$("#add-encrypted").prop("disabled","")})});